1. Read Processing and Mapping
1.1 Raw Read Filtering (FASTQ QC)
fastp \
  -i sample_R1.fq.gz \
  -I sample_R2.fq.gz \
  -o sample_R1.clean.fq.gz \
  -O sample_R2.clean.fq.gz \
  -q 20 \
  -u 40 \
  -l 70

1.2 Mapping Clean Reads to the Reference Genome
1.2.1 Build Reference Index
bwa index refer.fa
samtools dict refer.fa > refer.dict
samtools faidx refer.fa

1.2.2 Alignment
bwa mem \
  -R '@RG\tID:sample\tLB:sample\tSM:sample\tPL:ILLUMINA' \
  -t 30 \
  refer.fa \
  sample_R1.clean.fq.gz sample_R2.clean.fq.gz | \
  samtools view -Sb - > sample.pe.bam

1.2.3 BAM Sorting, Duplicate Removal, and Indexing
gatk SortSam \
  --INPUT sample.pe.bam \
  --OUTPUT sample.sort.bam \
  --SORT_ORDER coordinate

gatk MarkDuplicates \
  -I sample.sort.bam \
  -O sample.sort.markdup.bam \
  -M sample.sort.markdup_metrics.txt

samtools index sample.sort.markdup.bam

1.3 Alignment Statistics
samtools flagstat sample.sort.markdup.bam > sample_flagstat.txt

2. Variant Calling (GATK)
2.1 Generate Per-Sample gVCF
gatk --java-options "-Xmx10g" HaplotypeCaller \
  -R refer.fa \
  -I sample.sort.markdup.bam \
  -ERC GVCF \
  -O sample.g.vcf.gz

2.2 Combine gVCFs (Per Chromosome)
gatk --java-options "-Xmx20g" CombineGVCFs \
  -R refer.fa \
  -V sample1.g.vcf.gz \
  -V sample2.g.vcf.gz \
  ...
  -V sampleN.g.vcf.gz \
  -L 1 \
  -O Coconut_chr.1.g.vcf.gz

2.3 Joint Genotyping
gatk --java-options "-Xmx100g" GenotypeGVCFs \
  -R refer.fa \
  -V Coconut_chr.1.g.vcf.gz \
  -L 1 \
  -O Coconut_chr.1.raw.vcf.gz

2.4 Separate SNPs and INDELs
gatk SelectVariants \
  -select-type SNP \
  -V Coconut_chr.1.raw.vcf.gz \
  -O Coconut_chr.1.snp.vcf.gz

gatk SelectVariants \
  -select-type INDEL \
  -V Coconut_chr.1.raw.vcf.gz \
  -O Coconut_chr.1.indel.vcf.gz

3. Variant Filtering
3.1 SNP Hard Filtering
gatk --java-options "-Xmx10g" VariantFiltration \
  -V Coconut_chr.1.snp.vcf.gz \
  -filter "QD < 2.0" --filter-name "QD2" \
  -filter "QUAL < 30.0" --filter-name "QUAL30" \
  -filter "SOR > 3.0" --filter-name "SOR3" \
  -filter "FS > 60.0" --filter-name "FS60" \
  -filter "MQ < 40.0" --filter-name "MQ40" \
  -filter "MQRankSum < -12.5" --filter-name "MQRankSum-12.5" \
  -filter "ReadPosRankSum < -8.0" --filter-name "ReadPosRankSum-8" \
  -O Coconut_chr.1.filter.snp.vcf.gz

Keep only PASS variants:
vcftools --gzvcf Coconut_chr.1.filter.snp.vcf.gz \
  --remove-filtered-all --recode --stdout | \
  gzip -c > Coconut_chr.1.pass.snp.vcf.gz

3.2 Population-Level SNP Filtering
# Keep biallelic SNPs
vcftools --gzvcf Coconut_chr.1.pass.snp.vcf.gz \
  --min-alleles 2 --max-alleles 2 \
  --recode --stdout | gzip -c > Coconut_chr.1.bi.snp.vcf.gz

# Filter by missing rate and MAF
vcftools --gzvcf Coconut_chr.1.bi.snp.vcf.gz \
  --max-missing 0.5 \
  --maf 0.05 \
  --recode --stdout | \
  gzip -c > Coconut_chr.1.bi.maf0.05mis0.5.snp.vcf.gz

3.3 INDEL Filtering
gatk --java-options "-Xmx10g" VariantFiltration \
  -V Coconut_chr.1.indel.vcf.gz \
  -filter "QD < 2.0" --filter-name "QD2" \
  -filter "QUAL < 30.0" --filter-name "QUAL30" \
  -filter "SOR > 5.0" --filter-name "SOR5" \
  -filter "FS > 100.0" --filter-name "FS100" \
  -filter "InbreedingCoeff < -0.8" --filter-name "InbreedingCoeff-0.8" \
  -O Coconut_chr.1.filter.indel.vcf.gz

vcftools --gzvcf Coconut_chr.1.filter.indel.vcf.gz \
  --remove-filtered-all --recode --stdout | \
  gzip -c > Coconut_chr.1.pass.indel.vcf.gz

4. Merge Variants Across Chromosomes
bcftools concat -f vcf.list -o Coconut_OG_SNP.vcf
bgzip Coconut_OG_SNP.vcf
tabix Coconut_OG_SNP.vcf.gz

5. Functional Annotation with SnpEff
5.1 Prepare Directory Structure
mkdir data
mkdir genomes spices


Put the reference genome (Coconut.fa) into genomes/

Put the annotation file (renamed to Coconut.gff) into spices/

5.2 Configure SnpEff

Edit snpEff.config:

data.dir = ./data/
Coconut.genome : Coconut

5.3 Build Database
java -jar snpEff.jar build -gff3 -v Coconut -noCheckCds -noCheckProtein

5.4 Annotate Variants
java -jar snpEff.jar -v Coconut input.vcf > annotated.vcf
